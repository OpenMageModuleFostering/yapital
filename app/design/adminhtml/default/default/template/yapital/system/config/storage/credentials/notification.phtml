<?php /* var $this Codex_Yapital_Block_System_Config_Storage_Credentials_Notification */ ?>

<script type="text/javascript">
    //<![CDATA[
        /* Validation.add('required-validation', '<?php echo $this->__('Validation is required.') ?>', function(){
            storage = yapitalGetNotificationName(
                    $('payment_yapital_standard_notification_secret').value,
                    $('payment_yapital_standard_notification_id').value
            );

            return allowedNotifications.include(storage);
        }); */

    defaultValues = [];
    defaultValues['payment_yapital_standard_notification_secret'] = $('payment_yapital_standard_notification_secret').value;
    defaultValues['payment_yapital_standard_notification_id'] = $('payment_yapital_standard_notification_id').value;

    allowedNotifications = [];
    yapitalAddAllowedNotification(
            $('payment_yapital_standard_notification_secret').value,
            $('payment_yapital_standard_notification_id').value
    );

    function yapitalGetNotificationName(storageType, connection) {
        return storageType + '_' + connection;
    }

    function yapitalAddAllowedNotification(storageType, connection) {
        var storage = yapitalGetNotificationName(storageType, connection);

        if (storage != '' && !allowedNotifications.include(storage)) {
            allowedNotifications.push(storage);
        }
    }

    function yapitalNotificationsCheckButtonState(event) {
        var element = Event.element(event);

        var defaultStorage = yapitalGetNotificationName(
                defaultValues['payment_yapital_standard_notification_secret'],
                defaultValues['payment_yapital_standard_notification_id']
        );

        var storage = yapitalGetNotificationName(
                $('payment_yapital_standard_notification_secret').value,
                $('payment_yapital_standard_notification_id').value
        );

        if (defaultStorage != storage) {
            enableValidateButton();
        } else {
            disableValidateButton();
        }
    }

    function enableStorageSelection() {
        $('payment_yapital_standard_notification_secret').enable('enabled');
        $('payment_yapital_standard_notification_id').enable('enabled');
    }

    function disableStorageSelection() {
        $('payment_yapital_standard_notification_secret').disable('disabled');
        $('payment_yapital_standard_notification_id').disable('disabled');
    }

    function enableValidateButton() {
        Form.Element.enable('validate_button');
        $('validate_button').removeClassName('disabled');
    }

    function disableValidateButton() {
        Form.Element.disable('validate_button');
        $('validate_button').addClassName('disabled');
    }

    Event.observe(window, 'load', function () {
        //disableStorageSelection();
        //disableValidateButton();
        //checkStatus();
    });
    $('payment_yapital_standard_notification_secret').observe('change', yapitalNotificationsCheckButtonState);
    $('payment_yapital_standard_notification_id').observe('change', yapitalNotificationsCheckButtonState);

    function yapitalCheckNotificationStatus() {

    }

    function yapitalNotificationRegister() {
        //var advice = Validation.getAdvice('required-validation', $('synchronize-validation-input'));
        //if (advice) {
        //    advice.hide();
        //}

        params = {
            store_id :1,
            notification_secret :$('payment_yapital_standard_notification_secret').value,
            notification_id:$('payment_yapital_standard_notification_id').value
        };

        $('notification_message_span').addClassName('no-display');
        $('notification_span').removeClassName('no-display');

        new Ajax.Request('<?php echo $this->getAjaxRegisterUrl() ?>', {
            parameters  :params,
            loaderArea  :false,
            asynchronous:false,
            onSuccess   :function (transport) {
                var response;

                response = eval('(' + transport.responseText + ')');
                console.log(response);
                if (false == response.has_errors) {
                    // no errors: it works!
                    disableValidateButton();
                } else {
                    // TODO ERROR
                }

                allowedNotifications.push(yapitalGetNotificationName(
                        $('payment_yapital_standard_notification_secret').value,
                        $('payment_yapital_standard_notification_id').value
                ));

                $('notification_span').addClassName('no-display');
                $('notification_message_span').removeClassName('no-display');
                $('notification_message_span').update(response.message);
            },

            onFailure:function (transport) {
                $('validation_span').addClassName('no-display');
                $('validation_message_span').removeClassName('no-display');
                $('validation_message_span').update('<?php echo $this->__('Internal error during validation.') ?>');
            }

        });

        enableValidateButton();
    }
    //]]>
</script>

<?php echo $this->getButtonHtml() ?><span class="validation-indicator no-display" id="notification_span"><img
        alt="Synchronize" style="margin:0 5px" src="<?php echo $this->getSkinUrl('images/process_spinner.gif')
?>"/></span><span id="notification_message_span"></span>
<input type="hidden" id="validation-input" class="required-validation no-display"/>
